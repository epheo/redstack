---

- name: Register system and add subscription
  become: yes
  redhat_subscription:
    activationkey: '{{ subscription.activation_key }}'
    org_id: '{{ subscription.org }}'
    state: present

- name: Get Pool ID
  become: yes
  shell: |
    subscription-manager list \
     --available --all \
     --matches="Red Hat OpenStack" \
     \ | grep Pool\ ID |awk -F ' ' '{print $3}' |head -n1
  register: pool_id

- debug:
    var: pool_id.stdout_lines[0]
    
- name: Attach Pool ID
  become: yes
  shell: |
    subscription-manager attach --pool={{ pool_id.stdout_lines[0] }}
    
- name: Disable repositories
  become: yes
  shell: |
    subscription-manager repos --disable=*

- name: Subscribe repositories
  become: yes
  shell: |
    subscription-manager repos --enable={{ item }}
  loop: "{{ enable_repos }}"

- include_tasks: update.yaml